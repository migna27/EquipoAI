<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Analizador de Engranes</title>
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    
    <style>
        .valid-input { border-color: #28a745 !important; }
        .invalid-input { border-color: #dc3545 !important; }
    </style>

    <script>
        function agregarFila() {
            const tbody = document.getElementById("tbody-engranes");
            const fila = document.createElement("tr");
            fila.innerHTML = `
                <td><input type="number" name="diente[]" class="form-control" required oninput="validarInput(this)"></td>
                <td><input type="number" name="mant[]" class="form-control" required oninput="validarInput(this)"></td>
                <td><button type="button" class="btn btn-danger btn-sm" onclick="eliminarFila(this)">Eliminar</button></td>
            `;
            tbody.appendChild(fila);
        }
        function eliminarFila(btn) { btn.parentElement.parentElement.remove(); }
        function validarInput(input) {
            if (input.value.trim() === "" || parseInt(input.value) <= 0) {
                input.classList.add("invalid-input"); input.classList.remove("valid-input");
            } else {
                input.classList.add("valid-input"); input.classList.remove("invalid-input");
            }
        }
    </script>
</head>
<body>

<div class="container py-5">
    <h1 class="mb-4 text-center">‚öôÔ∏è Analizador de Sistema de Engranajes</h1>

    <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">Configuraci√≥n</div>
        <div class="card-body">
            <form method="POST">
                <div class="row mb-3 align-items-center">
                    <div class="col-auto">
                        <label><strong>RPM del Motor:</strong></label>
                        <input type="number" name="rpm_input" class="form-control" 
                               value="{{ resultados.rpm_motor if resultados else 100 }}" 
                               min="1" step="0.1" style="width: 120px; display:inline-block;">
                    </div>
                </div>

                <table class="table table-bordered table-striped">
                    <thead class="table-dark">
                        <tr><th>Dientes</th><th>Mantenimiento (h)</th><th>Acci√≥n</th></tr>
                    </thead>
                    <tbody id="tbody-engranes">
                        {% if resultados and resultados.dientes %}
                            {% for i in range(resultados.dientes|length) %}
                            <tr>
                                <td><input type="number" name="diente[]" class="form-control" value="{{ resultados.dientes[i] }}"></td>
                                <td><input type="number" name="mant[]" class="form-control" value="{{ resultados.mant[i] }}"></td>
                                <td><button type="button" class="btn btn-danger btn-sm" onclick="eliminarFila(this)">X</button></td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td><input type="number" name="diente[]" class="form-control"></td>
                                <td><input type="number" name="mant[]" class="form-control" ></td>
                                <td><button type="button" class="btn btn-danger btn-sm" onclick="eliminarFila(this)">X</button></td>
                            </tr>
                            <tr>
                                <td><input type="number" name="diente[]" class="form-control" ></td>
                                <td><input type="number" name="mant[]" class="form-control" ></td>
                                <td><button type="button" class="btn btn-danger btn-sm" onclick="eliminarFila(this)">X</button></td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
                <button type="button" class="btn btn-outline-primary" onclick="agregarFila()">+ Agregar</button>
                <button type="submit" class="btn btn-success">Calcular</button>
            </form>
        </div>
    </div>

    {% if resultados %}
    <div class="card shadow mt-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="text-primary">Resultados</h3>
                <a href="{{ url_for('descargar_pdf') }}" class="btn btn-warning">üìÑ Descargar PDF</a>
            </div>

            <div class="alert alert-info">
                Mantenimiento Global: Cada <strong>{{ resultados.mantenimiento_global }}</strong> horas.
            </div>

            <table class="table table-bordered text-center">
                <thead class="table-secondary">
                    <tr>
                        <th>Par</th>
                        <th>Dientes (A:B)</th>
                        <th>Relaci√≥n</th>
                        <th>RPM Salida</th>
                        <th>Ciclo</th>
                        <th>Mantenimiento (h)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in analisis_pares %}
                    <tr>
                        <td>{{ row.par }}</td>
                        <td>{{ row.A_d }} : {{ row.B_d }}</td>
                        <td class="fw-bold">{{ row.ratio }}</td>
                        <td class="text-success fw-bold">{{ row.rpm_salida }}</td>
                        <td>{{ row.ciclo }}</td>
                        <td>{{ row.rep_mant }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            {% include 'visualizacion.html' %}
        </div>
    </div>
    {% endif %}
</div>
</body>
</html>